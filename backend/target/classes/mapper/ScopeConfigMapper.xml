<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.newland.ucms.certificate.mapper.ScopeConfigMapper">

  <!-- 查询匹配的应用范围配置 -->
  <select id="findMatchingScopeConfig" resultType="com.newland.ucms.certificate.entity.ScopeConfig">
    SELECT * FROM UCMS_SCOPE_CONFIG
    WHERE is_deleted = 0
      AND status = 1
      AND (business_channel = #{businessChannel} OR business_channel IS NULL)
      AND (channel_sub_type = #{channelSubType} OR channel_sub_type IS NULL)
      AND (city = #{city} OR city IS NULL)
      AND (district = #{district} OR district IS NULL)
      AND (institution = #{institution} OR institution IS NULL)
    ORDER BY
      CASE WHEN institution IS NOT NULL THEN 0 ELSE 1 END,
      CASE WHEN district IS NOT NULL THEN 0 ELSE 1 END,
      CASE WHEN city IS NOT NULL THEN 0 ELSE 1 END,
      CASE WHEN channel_sub_type IS NOT NULL THEN 0 ELSE 1 END
      CASE WHEN business_channel IS NOT NULL THEN 0 ELSE 1 END
    LIMIT 1
  </select>

</mapper>
